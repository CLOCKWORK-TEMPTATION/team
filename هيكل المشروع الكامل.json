{
  "title": "هيكل المشروع الكامل (Monorepo TypeScript/Node + Electron)",
  "document": {
    "1_repository_tree": {
      "title": "الشجرة العامة للمستودع",
      "tree": "repo-refactor-ai/\n├─ .editorconfig\n├─ .gitignore\n├─ .npmrc\n├─ README.md\n├─ package.json\n├─ pnpm-workspace.yaml\n├─ tsconfig.base.json\n├─ tsconfig.node.json\n├─ eslint.config.js\n├─ prettier.config.cjs\n├─ scripts/\n│  ├─ ensure-node.mjs\n│  ├─ repo-snapshot.mjs\n│  └─ print-env.mjs\n├─ artifacts/                       # مخرجات التشغيل (يُتجاهل عبر gitignore)\n│  ├─ db/\n│  ├─ logs/\n│  ├─ reports/\n│  └─ runs/\n├─ apps/\n│  └─ desktop/                      # Electron Desktop App\n│     ├─ package.json\n│     ├─ electron-builder.yml\n│     ├─ tsconfig.json\n│     ├─ src/\n│     │  ├─ main/\n│     │  │  ├─ main.ts              # Electron Main Process\n│     │  │  ├─ menu.ts\n│     │  │  ├─ windows.ts\n│     │  │  ├─ lifecycle.ts\n│     │  │  └─ pipeline-runner.ts   # يستدعي Engine عبر API/CLI\n│     │  ├─ preload/\n│     │  │  ├─ preload.ts           # contextBridge + IPC\n│     │  │  └─ ipc-bridge.ts\n│     │  └─ renderer/\n│     │     ├─ index.html\n│     │     ├─ vite.config.ts\n│     │     ├─ tsconfig.json\n│     │     └─ src/\n│     │        ├─ app.tsx\n│     │        ├─ main.tsx\n│     │        ├─ routes/\n│     │        │  ├─ select-repo.tsx\n│     │        │  ├─ baseline.tsx\n│     │        │  ├─ report.tsx\n│     │        │  ├─ approval.tsx\n│     │        │  ├─ execute.tsx\n│     │        │  └─ results.tsx\n│     │        ├─ components/\n│     │        │  ├─ layout/\n│     │        │  ├─ report/\n│     │        │  ├─ tables/\n│     │        │  └─ common/\n│     │        ├─ state/\n│     │        │  ├─ store.ts\n│     │        │  └─ selectors.ts\n│     │        ├─ api/\n│     │        │  ├─ ipc-client.ts\n│     │        │  └─ types.ts\n│     │        └─ styles/\n│     │           └─ app.css\n├─ packages/\n│  ├─ shared/                       # Utilities مشتركة\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ fs/\n│  │     ├─ proc/\n│  │     ├─ log/\n│  │     ├─ crypto/\n│  │     └─ index.ts\n│  ├─ schemas/                      # Zod schemas + Types (Evidence/Plan/Findings)\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ evidence.ts\n│  │     ├─ findings.ts\n│  │     ├─ plan.ts\n│  │     ├─ report.ts\n│  │     ├─ telemetry.ts\n│  │     └─ index.ts\n│  ├─ storage/                      # SQLite + migrations + artifact store\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ db/\n│  │     │  ├─ schema.sql\n│  │     │  ├─ migrate.ts\n│  │     │  └─ client.ts\n│  │     ├─ artifacts/\n│  │     │  ├─ paths.ts\n│  │     │  ├─ writer.ts\n│  │     │  └─ reader.ts\n│  │     └─ index.ts\n│  ├─ tooling/                      # Wrappers لاستدعاء أدوات التحليل الساكن\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ tsc.ts\n│  │     ├─ eslint.ts\n│  │     ├─ knip.ts\n│  │     ├─ depcheck.ts\n│  │     ├─ jscpd.ts\n│  │     ├─ depcruise.ts\n│  │     ├─ vitest.ts\n│  │     ├─ jest.ts\n│  │     └─ index.ts\n│  ├─ analysis/                     # Core analysis pipeline (AST/Graphs/Findings)\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ repo/\n│  │     │  ├─ intake.ts\n│  │     │  ├─ profiler.ts\n│  │     │  ├─ entrypoints.ts\n│  │     │  └─ ignore.ts\n│  │     ├─ indexer/\n│  │     │  ├─ symbol-db.ts\n│  │     │  ├─ ts-morph.ts\n│  │     │  └─ references.ts\n│  │     ├─ graphs/\n│  │     │  ├─ import-graph.ts\n│  │     │  ├─ call-graph.ts\n│  │     │  ├─ type-graph.ts\n│  │     │  └─ graph-export.ts\n│  │     ├─ detectors/\n│  │     │  ├─ dead-code.ts\n│  │     │  ├─ duplicates.ts\n│  │     │  ├─ merge-candidates.ts\n│  │     │  └─ boundary-checks.ts\n│  │     ├─ semantic-clones/        # 7.1\n│  │     │  ├─ normalize-ast.ts\n│  │     │  ├─ subtree-hash.ts\n│  │     │  ├─ cluster.ts\n│  │     │  └─ index.ts\n│  │     ├─ contracts/              # 7.4\n│  │     │  ├─ contract-miner.ts\n│  │     │  ├─ contract-model.ts\n│  │     │  └─ index.ts\n│  │     ├─ risk/                   # 7.3\n│  │     │  ├─ risk-score.ts\n│  │     │  ├─ signals.ts\n│  │     │  └─ index.ts\n│  │     ├─ evidence/               # قاعدة 4.2\n│  │     │  ├─ evidence-pack.ts\n│  │     │  ├─ thresholds.ts\n│  │     │  └─ index.ts\n│  │     └─ index.ts\n│  ├─ harness/                      # 7.2 Behavioral Equivalence Harness\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ generators/\n│  │     │  ├─ snapshot.ts\n│  │     │  ├─ golden-files.ts\n│  │     │  ├─ property-based.ts\n│  │     │  └─ index.ts\n│  │     ├─ runner/\n│  │     │  ├─ before-after.ts\n│  │     │  ├─ compare.ts\n│  │     │  └─ index.ts\n│  │     ├─ contracts-integration.ts\n│  │     └─ index.ts\n│  ├─ planning/                     # تحويل findings إلى plan + report + gating\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ planner.ts\n│  │     ├─ patch-series.ts\n│  │     ├─ markdown-report.ts\n│  │     ├─ approval-gate.ts        # شرط الموافقة قبل التنفيذ\n│  │     ├─ evidence-gatekeeper.ts  # حارس 4.2\n│  │     └─ index.ts\n│  ├─ refactor/                     # تنفيذ الباتشات (لا تحليل هنا)\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ git/\n│  │     │  ├─ branch.ts\n│  │     │  ├─ commit.ts\n│  │     │  ├─ revert.ts\n│  │     │  └─ status.ts\n│  │     ├─ codemods/\n│  │     │  ├─ move-file.ts\n│  │     │  ├─ rename-symbol.ts\n│  │     │  ├─ extract-function.ts\n│  │     │  ├─ unify-duplicates.ts\n│  │     │  ├─ delete-dead.ts\n│  │     │  └─ index.ts\n│  │     ├─ apply-plan.ts\n│  │     ├─ verify.ts\n│  │     └─ index.ts\n│  ├─ llm/                          # مزودو النماذج + Router + سياسات\n│  │  ├─ package.json\n│  │  ├─ tsconfig.json\n│  │  └─ src/\n│  │     ├─ providers/\n│  │     │  ├─ openai.ts\n│  │     │  ├─ anthropic.ts\n│  │     │  ├─ google.ts\n│  │     │  ├─ mistral.ts\n│  │     │  ├─ xai.ts\n│  │     │  └─ deepseek.ts\n│  │     ├─ router.ts               # يختار نموذج حسب الدور: planning/coding/summarize\n│  │     ├─ prompts/\n│  │     │  ├─ planner.md\n│  │     │  ├─ patch-author.md\n│  │     │  ├─ risk-judge.md\n│  │     │  └─ report-writer.md\n│  │     └─ index.ts\n│  └─ engine/                       # Orchestrator + CLI + Telemetry\n│     ├─ package.json\n│     ├─ tsconfig.json\n│     └─ src/\n│        ├─ orchestrator/\n│        │  ├─ state.ts\n│        │  ├─ graph.ts             # fan-out/fan-in\n│        │  ├─ nodes.ts\n│        │  ├─ checkpoints.ts\n│        │  └─ index.ts\n│        ├─ telemetry/\n│        │  ├─ metrics.ts\n│        │  ├─ traces.ts\n│        │  └─ index.ts\n│        ├─ api/\n│        │  ├─ service.ts           # API يستدعيه Electron\n│        │  └─ types.ts\n│        ├─ cli/\n│        │  ├─ scan.ts\n│        │  ├─ plan.ts\n│        │  ├─ apply.ts\n│        │  ├─ verify.ts\n│        │  └─ index.ts\n│        └─ index.ts\n└─ docs/\n   ├─ architecture.md\n   ├─ evidence-policy.md\n   ├─ risk-scoring.md\n   ├─ boundaries.md\n   └─ ui-spec.md"
    },
    "2_packages_responsibilities": {
      "title": "توزيع المسؤوليات بين الحزم (Packages) — بشكل قاطع",
      "packages": [
        {
          "package": "packages/analysis",
          "responsibility": "استخراج الأدلة (AST/Graphs/Detectors) + بناء Evidence Packets",
          "hard_boundaries": "ممنوع تعديل الكود"
        },
        {
          "package": "packages/tooling",
          "responsibility": "استدعاء الأدوات (knip/depcheck/jscpd/depcruise/tsc/eslint)",
          "hard_boundaries": "ممنوع اتخاذ قرارات حذف/دمج"
        },
        {
          "package": "packages/planning",
          "responsibility": "تحويل الأدلة إلى خطة + تقرير + بوابة موافقة + حارس الأدلة",
          "hard_boundaries": "ممنوع تنفيذ تعديل فعلي"
        },
        {
          "package": "packages/refactor",
          "responsibility": "تنفيذ الخطة (codemods + git)",
          "hard_boundaries": "ممنوع استخراج findings جديدة"
        },
        {
          "package": "packages/harness",
          "responsibility": "اختبارات التكافؤ قبل/بعد للتغييرات عالية المخاطر",
          "hard_boundaries": "ممنوع اقتراح refactor جديد"
        },
        {
          "package": "packages/llm",
          "responsibility": "مزودو النماذج + Router + Prompts (للتحكيم/التخطيط/كتابة الباتشات)",
          "hard_boundaries": "ممنوع قرار بلا Evidence"
        },
        {
          "package": "packages/engine",
          "responsibility": "Orchestrator + CLI + Telemetry + API لـ Electron",
          "hard_boundaries": "ممنوع منطق تحليل تفصيلي"
        },
        {
          "package": "packages/storage",
          "responsibility": "SQLite + artifact store",
          "hard_boundaries": "لا منطق تحليل"
        },
        {
          "package": "packages/schemas",
          "responsibility": "Zod + Types موحّدة لكل البيانات",
          "hard_boundaries": "لا استدعاء أدوات خارجية"
        },
        {
          "package": "apps/desktop",
          "responsibility": "Electron UI + IPC",
          "hard_boundaries": "لا تحليل ولا تعديل على repo مباشرة"
        }
      ]
    },
    "3_root_files": {
      "title": "ملفات الجذر (Root) — الحد الأدنى اللازم للتشغيل",
      "files": {
        "pnpm-workspace.yaml": {
          "packages": [
            "apps/*",
            "packages/*"
          ]
        },
        "package.json": {
          "name": "repo-refactor-ai",
          "private": true,
          "packageManager": "pnpm@9.0.0",
          "engines": {
            "node": ">=20"
          },
          "scripts": {
            "dev": "pnpm -C apps/desktop dev",
            "build": "pnpm -r build",
            "lint": "pnpm -r lint",
            "typecheck": "pnpm -r typecheck",
            "engine:scan": "pnpm -C packages/engine cli:scan",
            "engine:plan": "pnpm -C packages/engine cli:plan",
            "engine:apply": "pnpm -C packages/engine cli:apply",
            "engine:verify": "pnpm -C packages/engine cli:verify"
          },
          "devDependencies": {
            "typescript": "^5.5.0",
            "eslint": "^9.0.0",
            "prettier": "^3.3.0"
          }
        },
        "tsconfig.base.json": {
          "compilerOptions": {
            "target": "ES2022",
            "module": "NodeNext",
            "moduleResolution": "NodeNext",
            "lib": [
              "ES2022",
              "DOM"
            ],
            "strict": true,
            "noUncheckedIndexedAccess": true,
            "exactOptionalPropertyTypes": true,
            "skipLibCheck": true,
            "resolveJsonModule": true,
            "esModuleInterop": true,
            "types": [
              "node"
            ]
          }
        }
      }
    },
    "4_electron_app": {
      "title": "Electron App (apps/desktop) — ما يلزمها بالضبط",
      "package_json": {
        "name": "@app/desktop",
        "private": true,
        "main": "dist/main/main.js",
        "scripts": {
          "dev": "vite --config src/renderer/vite.config.ts",
          "dev:electron": "ts-node src/main/main.ts",
          "build": "pnpm build:renderer && pnpm build:main && pnpm package",
          "build:renderer": "vite build --config src/renderer/vite.config.ts",
          "build:main": "tsc -p tsconfig.json",
          "package": "electron-builder"
        },
        "dependencies": {
          "@pkg/engine": "workspace:*",
          "@pkg/schemas": "workspace:*",
          "@pkg/storage": "workspace:*"
        },
        "devDependencies": {
          "electron": "^31.0.0",
          "electron-builder": "^24.0.0",
          "typescript": "^5.5.0",
          "vite": "^5.4.0",
          "react": "^18.3.0",
          "react-dom": "^18.3.0"
        }
      },
      "ipc_communication_node": {
        "title": "IPC عقدة الاتصال (مبدأ)",
        "principles": [
          "preload يعرّف API واحد فقط: window.repoRefactor.",
          "كل الاستدعاءات تمر عبر packages/engine/api/service.ts لضمان نفس القيود والسياسات."
        ]
      }
    },
    "5_pipeline_systems_integration": {
      "title": "تضمين 7.1–7.5 داخل الهيكل (أماكنها)",
      "systems": {
        "7.1_semantic_clone_clustering": {
          "name": "Semantic Clone Clustering",
          "location": "packages/analysis/src/semantic-clones/*"
        },
        "7.2_behavioral_equivalence_harness": {
          "name": "Behavioral Equivalence Harness",
          "location": "packages/harness/*"
        },
        "7.3_risk_scored_refactor": {
          "name": "Risk-Scored Refactor",
          "location": "packages/analysis/src/risk/*",
          "integration": "دمجه في packages/planning/planner.ts"
        },
        "7.4_refactor_by_contracts": {
          "name": "Refactor by Contracts",
          "location": "packages/analysis/src/contracts/*",
          "integration": "دمجه في packages/harness/contracts-integration.ts"
        },
        "7.5_boundaries_aware_merging": {
          "name": "Boundaries-Aware Merging",
          "discovery": "packages/analysis/src/detectors/boundary-checks.ts",
          "enforcement": "packages/planning/src/evidence-gatekeeper.ts + قواعد eslint/dependency-cruiser"
        }
      }
    },
    "6_core_rule_4_2_integration": {
      "title": "قاعدة 4.2 داخل الهيكل (أين تُفرض فعليًا)",
      "implementation_locations": {
        "إنشاء Evidence Packets": "packages/analysis/src/evidence/evidence-pack.ts",
        "تحديد العتبات": "packages/analysis/src/evidence/thresholds.ts",
        "حارس التنفيذ (يرفض أي خطوة بلا دليل)": "packages/planning/src/evidence-gatekeeper.ts",
        "بوابة الموافقة قبل التنفيذ": "packages/planning/src/approval-gate.ts + تكامل UI في apps/desktop"
      }
    },
    "7_documentation_files": {
      "title": "ملفات التوثيق التشغيلية (docs) — إلزامية لتشغيل “من الألف للياء”",
      "files": {
        "docs/evidence-policy.md": "تعريف Evidence Threshold + استثناءات الديناميكية",
        "docs/risk-scoring.md": "أوزان المخاطر + معايير High Risk",
        "docs/boundaries.md": "قواعد الطبقات + ماذا يعني “دمج مسموح”",
        "docs/ui-spec.md": "صفحات UI + حالاتها + أزرار التحكم + Emergency Stop",
        "docs/architecture.md": "تدفق orchestrator (fan-out/fan-in + approval gate)"
      }
    }
  }
}
{
  "title": "ملفات الإعدادات الأساسية الجاهزة للنسخ",
  "document": {
    "1_boundaries_choice": {
      "title": "اختيار الخيار الثالث (Boundaries) — الأكثر كفاءة وتأثيرًا",
      "decision": "أختار: “الحدود البسيطة القابلة للتهيئة (Configurable Simple Boundaries)” كافتراضي، مع وضع FSD اختياري يُفعَّل فقط إذا كان المستودع المستهدف يستخدم FSD فعليًا أو يمكن ترحيله إليه بدون تكلفة عالية.",
      "reasons": [
        "أعلى قابلية تعميم على أي مستودع TypeScript/Node (Next/Vite/Nest/Express/CLI/Monorepo…)، بدون افتراض بنية مسبقة.",
        "أقل احتكاك: لا يفرض إعادة تنظيم مجلدات واسعة لمجرد “الالتزام بقالب”.",
        "أكبر تأثير فوري: يمنع الدوائر (cycles) والانهيارات المعمارية، ويجعل الدمج (7.5) “آمنًا” بشكل مباشر.",
        "FSD ممتاز عندما يكون موجودًا أو عندما تكون الهجرة إليه “مشروعًا” مستقلًا. فرضه تلقائيًا أثناء ريفكتور عام يزيد المخاطر والكلفة."
      ]
    },
    "2_vitest_and_harness_policies": {
      "title": "قرارا Vitest و Harness داخل repo — تحويلهما لسياسات تنفيذية",
      "vitest_selection": {
        "title": "اختيار Vitest",
        "policy": "يكون محرك الـ Harness الافتراضي: Vitest.",
        "agent_behavior": [
          "إن كان vitest موجودًا في devDependencies → يستخدمه مباشرة.",
          "إن لم يكن موجودًا → يضيفه كباتش مستقل ضمن الخطة ويُعرض في التقرير للموافقة قبل التنفيذ."
        ]
      },
      "in_repo_harness": {
        "title": "Harness داخل المستودع المستهدف (In-Repo)",
        "folder_structure": "<target-repo>/\n└─ .refactor-harness/\n   ├─ vitest.config.ts\n   ├─ package.json           # اختياري (عند الحاجة لعزل config)\n   ├─ src/\n   ├─ tests/\n   ├─ fixtures/\n   └─ README.md",
        "cleanup_policy": [
          "يُنشأ الـ Harness في باتش مستقل منخفض المخاطر.",
          "يمكن إبقاؤه (إذا رغبت) أو إزالته في باتش أخير “Cleanup” (يظل ذلك خيارًا ضمن الخطة ويخضع للموافقة)."
        ]
      }
    },
    "3_mandatory_rules": {
      "title": "إدخال “النواقص” كقواعد إلزامية داخل النظام",
      "entry_points": {
        "title": "Entry Points (إلزامي)",
        "location": "packages/analysis/src/repo/entrypoints.ts",
        "builds": [
          "runtime_entrypoints من package.json (main, exports, bin, types) + أطر التشغيل (Next/Vite/Nest…)",
          "test_entrypoints من (vitest/jest configs) + مسارات test/spec",
          "tooling_entrypoints مثل scripts/build tools إن وُجدت"
        ]
      },
      "dynamic_exceptions": {
        "title": "استثناءات الديناميكية (إلزامي)",
        "conditions": [
          "dynamic import / require المتغير",
          "registries/plugins",
          "string-based dispatch (events, DI tokens)"
        ],
        "action": "يُعلَّم dynamicSuspicion=true ويرتفع خطره ويُمنع الحذف التلقائي إلا بدليل أقوى."
      },
      "evidence_threshold": {
        "title": "Evidence Threshold (إلزامي)",
        "rule": "لا Delete/Merge/Move بدون Evidence Packet (كما في schemas) + عبور حارس الأدلة."
      },
      "public_api_protection": {
        "title": "حماية الـ Public API (إلزامي)",
        "impacted_areas": [
          "exports في package.json",
          "واجهات index.ts العامة",
          "أنواع مصدّرة widely-used"
        ],
        "action": "يرتفع إلى risk=high ويُفرض عليه Harness عند التنفيذ."
      },
      "atomic_patch_series": {
        "title": "Atomic Patch Series + Rollback (إلزامي)",
        "rules": [
          "كل خطوة = commit مستقل",
          "فشل التحقق بعد خطوة → revert تلقائي + إعادة تخطيط (أو وسم “تعذر آليًا”)"
        ]
      },
      "noise_guard": {
        "title": "Noise Guard (إلزامي)",
        "rule": "تشغيل formatter/linter لكن ضمن حدود التغيير (لا إعادة تنسيق شاملة خارج نطاق الباتش)"
      },
      "scope_explosion_stop": {
        "title": "Scope Explosion Stop (إلزامي)",
        "condition": "إذا تجاوز التغيير حدود الخطة (ملفات/أسطر/تحركات):",
        "action": "توقف آلي + إعادة تخطيط + تقرير سبب الانفجار"
      }
    },
    "4_pipeline_systems_integration": {
      "title": "إدراج 7.1–7.5 في الهيكل كمسارات تشغيل فعلية",
      "locations": {
        "7.1": "packages/analysis/src/semantic-clones/*",
        "7.2": "packages/harness/*",
        "7.3": "packages/analysis/src/risk/* + دمجه في packages/planning/src/planner.ts",
        "7.4": "packages/analysis/src/contracts/* + دمجه في packages/harness/contracts-integration.ts",
        "7.5": "packages/analysis/src/detectors/boundary-checks.ts + فرضه في packages/planning/src/evidence-gatekeeper.ts"
      }
    },
    "5_simple_boundaries_config": {
      "title": "تطبيق “Boundaries بسيطة” داخل مشروعك (repo-refactor-ai) — ملفات إعداد جاهزة",
      "dependency_cruiser": {
        "title": "Dependency-Cruiser (الأكثر تأثيرًا لمنع الدوائر والاختراقات)",
        "file_name": "dependency-cruiser.js",
        "content": "/** @type {import('dependency-cruiser').IConfiguration} */\nmodule.exports = {\n  forbidden: [\n    {\n      name: \"no-circular\",\n      severity: \"error\",\n      from: {},\n      to: { circular: true }\n    },\n    {\n      name: \"no-packages-import-apps\",\n      severity: \"error\",\n      from: { path: \"^packages/\" },\n      to: { path: \"^apps/\" }\n    },\n    {\n      name: \"schemas-should-be-leaf\",\n      severity: \"error\",\n      from: { path: \"^packages/schemas/\" },\n      to: { path: \"^packages/(analysis|planning|refactor|engine|llm|harness|tooling|storage|shared)/\" }\n    },\n    {\n      name: \"shared-should-not-depend-on-high-level\",\n      severity: \"error\",\n      from: { path: \"^packages/shared/\" },\n      to: { path: \"^packages/(analysis|planning|refactor|engine|llm|harness)/\" }\n    },\n    {\n      name: \"storage-should-not-depend-on-high-level\",\n      severity: \"error\",\n      from: { path: \"^packages/storage/\" },\n      to: { path: \"^packages/(analysis|planning|refactor|engine|llm|harness)/\" }\n    },\n    {\n      name: \"tooling-depends-only-on-base\",\n      severity: \"error\",\n      from: { path: \"^packages/tooling/\" },\n      to: { path: \"^packages/(analysis|planning|refactor|engine|llm|harness)/\" }\n    },\n    {\n      name: \"analysis-should-not-depend-on-planning-refactor-engine\",\n      severity: \"error\",\n      from: { path: \"^packages/analysis/\" },\n      to: { path: \"^packages/(planning|refactor|engine)/\" }\n    },\n    {\n      name: \"planning-should-not-depend-on-refactor-engine\",\n      severity: \"error\",\n      from: { path: \"^packages/planning/\" },\n      to: { path: \"^packages/(refactor|engine)/\" }\n    },\n    {\n      name: \"refactor-should-not-depend-on-analysis-planning-engine\",\n      severity: \"error\",\n      from: { path: \"^packages/refactor/\" },\n      to: { path: \"^packages/(analysis|planning|engine)/\" }\n    },\n    {\n      name: \"llm-should-not-depend-on-engine\",\n      severity: \"error\",\n      from: { path: \"^packages/llm/\" },\n      to: { path: \"^packages/engine/\" }\n    }\n  ],\n  options: {\n    doNotFollow: {\n      path: \"node_modules|dist|build|out|artifacts\"\n    },\n    enhancedResolveOptions: {\n      exportsFields: [\"exports\"],\n      conditionNames: [\"import\", \"require\", \"node\"]\n    },\n    tsConfig: {\n      fileName: \"tsconfig.base.json\"\n    }\n  }\n};",
        "package_json_script": {
          "scripts": {
            "deps:check": "depcruise -c dependency-cruiser.js ."
          }
        }
      }
    },
    "6_vitest_integration": {
      "title": "تضمين Vitest في مشروعك (repo-refactor-ai) + كونه محرك Harness للهدف",
      "tool_repo": {
        "title": "داخل مشروع الأداة نفسه",
        "recommendation": "استخدم Vitest أيضًا داخل الأداة لتوحيد البيئة (اختياري لكنه عملي).",
        "file_name": "vitest.config.ts",
        "content": "import { defineConfig } from \"vitest/config\";\n\nexport default defineConfig({\n  test: {\n    environment: \"node\",\n    include: [\"**/*.test.ts\"],\n    exclude: [\"**/node_modules/**\", \"**/dist/**\", \"**/artifacts/**\"]\n  }\n});"
      },
      "target_repo": {
        "title": "داخل المستودع الهدف (In-Repo Harness)",
        "policy": "السياسة داخل packages/harness: إذا لم يوجد Vitest في repo الهدف:",
        "actions": [
          "إضافة vitest + @vitest/coverage-v8 (عند الحاجة) كـ devDependencies",
          "إنشاء .refactor-harness/vitest.config.ts",
          "إنشاء tests “before/after” + golden fixtures",
          "كل ذلك في باتش مستقل يُعرض في التقرير للموافقة"
        ]
      }
    },
    "7_simple_boundaries_merging": {
      "title": "اختيار “Boundaries بسيطة” كمنطق دمج واعٍ (7.5) داخل repo الهدف",
      "rules": [
        "منع الدوائر (cycles) قبل وبعد الدمج.",
        "منع “دمج يخلق Fan-in/Fan-out غير مبرر” (باستخدام risk score).",
        {
          "rule": "منع دمج يعبر حدود وحدات واضحة (modules) تُستنتج من:",
          "sub_rules": [
            "import graph clusters",
            "package.json workspaces (إن وجدت)",
            "مجلدات كبرى (src/server, src/client, src/lib …) كحدود طبيعية"
          ]
        },
        {
          "rule": "إذا كان repo الهدف يطابق FSD فعليًا (دلائل: shared/entities/features/widgets/pages):",
          "sub_rules": [
            "يُفعّل وضع FSD كـ profile",
            "وإلا يبقى على simple boundaries"
          ]
        }
      ]
    },
    "8_providers_structure": {
      "title": "مزودو النماذج داخل هذا المشروع (Providers) — أين تضعهم في الهيكل",
      "providers_location": "packages/llm/src/providers/",
      "providers": [
        "openai.ts",
        "anthropic.ts",
        "google.ts",
        "mistral.ts",
        "xai.ts",
        "deepseek.ts"
      ],
      "router_location": "packages/llm/src/router.ts",
      "router_roles": [
        "planning/judging (تحكيم وخطة)",
        "coding/patch-author (كتابة وتعديل)",
        "summarize/report (تلخيص وصياغة تقرير)"
      ]
    },
    "note": "إذا كان مطلوبًا الآن: كتابة ملفات الإعدادات المتبقية حرفيًا داخل الشجرة (ESLint config الكامل للـ boundaries، إعداد depcruise داخل packages/tooling، قوالب .refactor-harness التي تُكتب داخل repo الهدف، وملفات schemas Zod للـ Evidence/Plan/Findings) اكتب: “اكتب ملفات الإعدادات كاملة”"
  }
}